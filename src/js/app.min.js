(function(a){"use strict";var b=function(){var a=Backbone.Model.extend({}),c=Backbone.Model.extend({}),d=Backbone.Collection.extend({model:a,sync:function(a,b,c){c.dataType="jsonp";return Backbone.sync(a,b,c)},parse:function(a){return a[2]},url:"https://api.mercadolibre.com/sites"}),e=Backbone.Collection.extend({model:c,sync:function(a,b,c){c.dataType="jsonp";return Backbone.sync(a,b,c)},parse:function(a){this.total=a[2].paging.total;return a[2].results},updateUrl:function(a){return this.url="https://api.mercadolibre.com/sites/"+a+"/search"},url:function(){return"https://api.mercadolibre.com/sites/"+localStorage["seekerSite"]+"/search"}}),f=Backbone.View.extend({tagName:"select",className:"countries",template:function(a){var b=['<option data-id="'+a.id+'" value="'+a.id+'">'+a.name+"</option>"];return b.join("")},initialize:function(){var a=this;this.collection=new d;this.collection.sync("read",this.collection,{success:function(b){a.collection.reset(b[2]);a.render();if(!localStorage["seekerSite"]){a.createMap();$.getJSON("https://wipmania.com/jsonp?callback=?",function(b){localStorage["seekerSite"]=a.countryMap[b.address.country]||"MLA"})}}});this.on("changeSite",function(a){localStorage["seekerSite"]=a;b.header.seeker.collection.updateUrl(a);$(".ch-icon-list").click()})},render:function(){this.$el.append('<option value="">Selecciona un país...</option>');_.each(this.collection.models,function(a){this.$el.append(this.template(a.toJSON()))},this);$("#navigation").append(this.$el)},events:{change:"changeSite"},changeSite:function(a){this.trigger("changeSite",a.srcElement.value);return false},createMap:function(){var a={};_.each(this.collection.models,function(b){a[b.get("name")]=b.id});this.countryMap=a}}),g=Backbone.View.extend({tagName:"li",template:function(a){var b=['<article class="item">','<a href="#item/'+a.id+'" data-permalink="'+a.permalink+'">','<figure><img src="'+a.thumbnail+'" alt="'+a.title+'" width="90" height="90"/></figure>',"<h2>"+a.title+"</h2>",'<p class="location">En '+a.address.state_name+"</p>",'<p class="ch-price">'+a.currency_id+" "+a.price+"</p>","</a>","</article>"];return b.join("")},render:function(){var a=this.model,b=a.get("stop_time").split("T");a.set("currency_id",this.currencyMap[a.get("currency_id")]);a.set("picture",a.get("thumbnail").replace("v_I_f","v_O_f"));a.set("condition",this.conditionMap[a.get("condition")]);a.set("countDown",this.countDown(a.get("stop_time")));a.set("stop_date",b[0]);a.set("stop_hour",b[1].split(".")[0]);a.set("buying_mode",this.buyingModeMap[a.get("buying_mode")]);a=a.toJSON();$(this.el).html(this.template(a));return this},countDown:function(a){var b=new Date(a),c=new Date,d=b.getTime()-c.getTime(),e=Math.floor(d/(1e3*60*60*24));return e},conditionMap:{"new":"Nuevo",used:"Usado"},buyingModeMap:{auction:"Subasta",buy_it_now:"Compra Inmediata"},currencyMap:{BRL:"R$",UYU:"$",CLP:"$",MXN:"$",DOP:"$",PAB:"B/.",COP:"$",VEF:"BsF",EUR:"€",PEN:"S/.",CRC:"¢",ARS:"$",USD:"U$S"}}),h=Backbone.View.extend({el:"#results",initialize:function(a){this.offset=0;this.limit=10;this.query=a.query;this.collection=new e;this.$el.prepend(this.$list).prepend(this.$notFound)},events:{scroll:"more"},$list:$('<ul class="slats ch-slats ch-list">'),$loading:$(".ch-loading-wrap"),$notFound:$('<p class="ch-hide ch-form-action ch-box-highlight">No se encontraron resultados.</p>'),render:function(){var a=this;_.each(this.collection.models.slice(this.offset),function(b){var c=new g({model:b});a.$list.append(c.render(b).el)},this);if(this.collection.total===0){this.$notFound.removeClass("ch-hide")}return this},fetch:function(a){var b=this,a=a||{},c=a.add||false;this.$loading.removeClass("ch-hide");this.collection.fetch({add:c,data:{q:b.query,limit:this.limit,offset:b.offset},success:function(){b.$loading.addClass("ch-hide");b.render()}})},start:function(a){this.query=a;this.offset=0;this.reset();$("#results").removeClass("ch-hide");this.fetch()},more:function(){var a=this.$list.height()-this.$el.height(),b=this.el.scrollTop;if(a===b){this.offset+=this.limit;this.fetch({add:true})}},reset:function(){this.collection.reset();this.$notFound.addClass("ch-hide");this.$list.html("")}}),i=Backbone.View.extend({el:"#vip",template:function(a){var b=['<article id="item">',"<h1>"+a.title+"</h1>",'<p class="ch-price">'+a.currency_id+" "+a.price+"</p>","<figure>",'<img src="'+a.picture+'" alt="'+a.title+'"/>',"</figure>",'<ul class="ch-list">','<li class="ch-icon-gift">'+a.condition+"</li>",'<li class="ch-icon-tags">'+a.buying_mode+"</li>",'<li class="ch-icon-calendar">Finaliza el '+a.stop_date+" a las "+a.stop_hour+" (en "+a.countDown+" días)</li>",'<li class="ch-icon-map-marker">'+a.address.city_name+", "+a.address.state_name+"</li>",'<li class="ch-icon-shopping-cart">'+a.sold_quantity+" vendidos</li>","</ul>",'<a href="'+a.permalink+'" class="ch-btn buy">Ver en MercadoLibre</a>',"</article>"];return b.join("")},events:{"click .buy":"buy"},render:function(a){$(this.el).html(this.template(a));return this},buy:function(a){chrome.tabs.create({url:a.target.href})}}),j=Backbone.View.extend({el:".ch-header",$query:$("#query"),initialize:function(a){this.app=a;this.renderSites();this.seekerInit()},events:{"submit .ch-header-form":"seek"},renderSites:function(){ch.mobile.menu($(".ch-header menu li"));this.sites=new f},seekerInit:function(){this.seeker=new h(this.app)},seek:function(){var a=this.app;a.query=this.$query.val().trim();this.seeker.start(a.query);return false}}),k=Backbone.Router.extend({routes:{"":"index","item/:id":"vip"},$search:$('[data-page="search"]'),$vip:$('[data-page="vip"]'),initialize:function(){this.query="";this.header=new j(this);this.vip=new i},transition:function(){this.$search.toggleClass("ch-hiden");this.$vip.toggleClass("ch-hide")},index:function(){this.$search.removeClass("ch-hiden");this.$vip.addClass("ch-hide")},vip:function(a){this.transition();var b=this.header.seeker.collection.get(a)["attributes"];this.vip.render(b)}}),l={Seeker:k};return l}();a.app=b})(this)